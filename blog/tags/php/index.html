<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
    <title><![CDATA[Ciaran McNulty]]></title>
    <link href="/blog/tags/php" rel="self"/>
    <link href="/"/>
    <updated>2016-02-13T09:34:57+00:00</updated>
    <id>/</id>
        <generator uri="http://sculpin.io/">Sculpin</generator>
            <entry>
            <title type="html"><![CDATA[Speaking in 2015]]></title>
            <link href="/speaking-in-2015"/>
            <updated>2015-12-24T00:00:00+00:00</updated>
            <id>/speaking-in-2015</id>
            <content type="html"><![CDATA[<p>2015 was the year I started submitting papers to conferences to try and get some speaking gigs. I expected to get a few acceptances but the actual response was really amazing.</p>

<p>I'd expected to not be accepted to many, so I applied to most of the conferences I saw that I could make it to. In the end my acceptance rate was about 40% so I ended up at seven conferences throughout the year.</p>

<p>That's not a lot by some people's standards but it made me feel pretty busy, especially as they weren't evenly distributed.</p>

<p>I was going to write about each conference individually but I fell behind, so here's a recap of my year.</p>

<h1>PHPUK, London</h1>

<p>It all started back in Feb at PHPUK, which I wrote about already so you may as well <a href="/speaking-at-phpuk-2015/">read about it in my previous post</a>.</p>

<iframe width="560" height="315" src="https://www.youtube.com/embed/DlgadZLOK-M" frameborder="0" allowfullscreen></iframe>

<p>Overall it went well, and the positive feedback from this talk is what I credit with a lot of the later acceptances.</p>

<h1>PhpDay, Verona</h1>

<p>PhpDay was my first conference abroad, and was a little nerve-wracking because I didn't know <em>anyone</em> who was going. It was exciting to be invited overseas though, and the idea someone was going to pay for my travel just to hear me speak was really gratifying (although now I think about it that is a very good description of my day job, I guess it's that I was accepted as myself not as a representative of a company).</p>

<iframe src="https://player.vimeo.com/video/134281522" width="500" height="281" frameborder="0" webkitallowfullscreen mozallowfullscreen allowfullscreen></iframe>

<p>I decided to do a straight introductory PhpSpec talk, but looking at past talks I felt challenged by a slide-driven format. I think to understand TDD you need to feel the workflow, so I came up with a 'live-coding-like' animation format to show it. It felt like it worked on the day and I was pretty pleased.</p>

<p>Again the talk went well but for me the highlight of the conference was to get to know some of the other speakers a little better. There were plenty of late-night chats in the bar area and the organisers took us to a <em>fantastic</em> restaurant in Verona for the speaker's dinner. It was the first time in Italy for me so trying the delicious real cuisine of the area was great.</p>

<p>The whole conference had a friendly, open spirit that is sometimes missing at the larger conferences and I'm very much hoping to go again next year.</p>

<h1>Symfony Live, London</h1>

<p>It wasn't completely out of the blue that I was accepted, after all I help to organise the conference so a lot of the selection panel were familiar with my work. All I will say though is that I didn't vote for my own talk!</p>

<p>On the tutorial day I co-delivered a DDD workshop with <a href="https://twitter.com/mr_r_miller">Richard Miller</a>. It went well and I really enjoy presenting with Richard - we both don't prepare an over-rehearsed script ahead of time so it adds a certain spontaneity. We also don't mind interrupting or contradicting each other when we're talking which maybe adds an element of performance.</p>

<p>On the main day, what I tried to do with my talk was give an overview of what testing tools were available and which were most appropriate to use in different circumstances.</p>

<p>My agenda was really to stop people asking me 'which is better, PHPUnit or PhpSpec?'.</p>

<iframe width="560" height="315" src="https://www.youtube.com/embed/jINf8_tgjSU" frameborder="0" allowfullscreen></iframe>

<p>In the end I felt crammed for time and a bit disappointed with the final talk. It's got stuff in it that's valuable (and certainly got good feedback from attendees) but I felt like the overall structure wasn't in place.</p>

<p>I'm hoping to deliver this again in a modified form in future to have another crack at it.</p>

<p>The conference itself was great as always; the venue we use is in a stunning location and the social was well-attended. Because it was in London it was a pretty familiar environment for me so the main thing was catching up with people from out of town.</p>

<h1>PhpConf.Asia, Singapore</h1>

<p>OK this was an exciting one to be accepted to!</p>

<p>This was the first pan-Asian PHP Conference, ably organised by <a href="https://twitter.com/coderkungfu">Michael Cheng</a>.</p>

<p>There was a live stream of the conference but I've not seen videos yet. I'll post here if one emerges.</p>

<p><img src="https://pbs.twimg.com/media/CP1660kUcAEYjl3.jpg"></p>

<p>I was very pleased that <a href="https://twitter.com/super_marek">Marek Matulka</a> was also accepted because it meant I had a travel buddy who's similarly obsessed with frequent flying programmes!</p>

<p>The flight to Singapore was long and tiring but the conference was great. It was in the university and was the first time I've seen a conference audience sitting at round tables, dinner-style.</p>

<p>My talk was a reworking of the one I delivered at PHPUK. On reviewing the slides I found I didn't have to change much, I mostly normalised all of the examples into PHPUnit (I had a mix of different tools in the original which people said was hard to follow).</p>

<p>I was pleased with the way it went and I got some very effusive feedback from some of the attendees who'd never got into testing before.</p>

<p>I don't think I made the most of the social side of the conference - the jet lag was too much. If I go again I'll definitely try to arrive a day more earlier.</p>

<p>The hospitality from Michael and the other organisers was excellent - Singaporeans seem to love to eat and we were very generously looked after!</p>

<p>It was really special being at the first of these conferences. A highlight for me was during <a href="https://twitter.com/miss_jwo">Jenny Wong</a>'s keynote she asked people who'd not been to a conference before to stand and it was at least 75% of the audience!</p>

<p>The PHP ecosystem is built on community so this conference could be the start of something big in Asian PHP adoption.</p>

<h1>PHPNW, Manchester</h1>

<p>I'd not been to PHPNW but had heard good things about it from Inviqa people. It didn't disappoint!</p>

<p>I did a half-day tutorial about PhpSpec on the first day, and I used the animated presentation style I developed for my PhpDay talk with some extra exercises.</p>

<p>I was told a few days before the workshop that 20+ people had signed up, but when I arrived there were about 16 desks. I assumed there was some mistake, but people kept coming in until it was standing room only! Luckily an organiser managed to whip up some extra desks and the staff sorted the situation out very quickly.</p>

<p>In the end having that many people doing code kata in pairs was a great experience.</p>

<p><img src="https://pbs.twimg.com/media/CQU5bTzWoAIvAu9.jpg"></p>

<p>The talk I delivered on the main day was a new one about <a href="http://everzet.com/post/99045129766/introducing-modelling-by-example">Modelling by Example</a>. I actually had to put it together in a few days due to my bad preparation so the slides aren't very spectacular, but it's a subject that I've been thinking about a lot over the last year so the ideas came out pretty quickly. I've done the same talk since and haven't felt the need to change it very much.</p>

<p>I think this is the talk I felt best about this year; the feedback was really positive and it felt really natural to deliver.</p>

<iframe width="560" height="315" src="https://www.youtube.com/embed/PIhJX4bLy6M" frameborder="0" allowfullscreen></iframe>

<p>The social side of PHPNW was good; lots of UK folk I know and a few out-of-towners. Again I left thinking I'd not made the most of it, I think I might just need to come to terms with the fact I find it hard to take part in conferences I'm also speaking at.</p>

<h1>True North PHP, Toronto</h1>

<p>I was very pleased to be selected to speak here because it's co-organised by <a href="https://twitter.com/grmpyprogrammer">Chris Hartjes</a> who is a big advocate of testing and we've had a fair bit of Twitter-based interaction.</p>

<p>Was nice to meet Chris but <em>again</em> jet lag and speaking nerves meant I was a bit withdrawn at the social events (at the speakers dinner I was furnished with one of the biggest steaks I've ever seen).</p>

<p><img src="https://pbs.twimg.com/media/CTI73eNUYAAKwH6.jpg"></p>

<p>My talk was an introductory PhpSpec talk. I've found that I am familiar enough with the structure of the slide deck that I can deliver the talk in a fairly relaxed way and throw in extra bits and pieces as I go.</p>

<p>My only regret was I scheduled my flights to arrive quite soon before and leave quite soon after the conference, next time I'll try and give it more time so I can actually relax and see some of Toronto.</p>

<p>We were really looked after at this conference, which I really appreciated, including being ferried around between Airport, Conference, Social and Hotel by the friendly organisers. This made a big difference to my anxiety levels!</p>

<h1>PhpCon Poland, Ossa</h1>

<p>I was encouraged to apply to this by <a href="https://twitter.com/cakper">Kacper Gunia</a>, who I used to work with with and helps organise the event.</p>

<p>In the end I did my testing talk from PHPUK and my Modelling by Example talk, both of which went down ok. They didn't need me to talk about PhpSpec because Kacper was doing a talk himself! I went to see it and it seemed good but it was hard for me to tell as he was speaking in Polish.</p>

<p>There was an incident at the start of my first talk that tested me a little - it took about 15 mins to get the projector working at the beginning (it was traced to the power switch being off!) so it was a little uncomfortable standing in front of an audience for that amount of time.</p>

<p>Trying to fix it:</p>

<p><img src="https://pbs.twimg.com/media/CTybwGAWEAAoBlJ.jpg"></p>

<p>In the end I was pleased with how I coped; I think at the start of the year it might have thrown me off but I did ok.</p>

<iframe src="https://player.vimeo.com/video/154094214" width="500" height="281" frameborder="0" webkitallowfullscreen mozallowfullscreen allowfullscreen></iframe>

<iframe src="https://player.vimeo.com/video/154091775" width="500" height="281" frameborder="0" webkitallowfullscreen mozallowfullscreen allowfullscreen></iframe>

<p>The conference was held in a huge hotel out of town; it was a very pleasant place, unfortunately I forgot to bring my swimming trunks.</p>

<p>It's also the first place I've seen the audience of a talk drinking free beers at 10am!</p>

<p>There was less English content than I'd expected (partly because the English talks were scheduled against each other) so I'll definitely consider coming again as a delegate but probably not as an attendee.</p>

<h1>What's next</h1>

<p>After a year of trying it, I'm definitely going to be speaking at more next year.</p>

<p>I think in 2016 I'll try and get to more UK events, especially some of the framework-specific conferences outside my usual area (e.g. Drupal, Magento, Laravel conferences). I'd also like to go to a US conference if possible.</p>

<p>I was disappointed not to be accepted by PHPUK after getting such good feedback last time, but their acceptance process is blind so it's possible I just need to raise my abstract-writing game.</p>

<p>That said, the only conference I'm definitely doing next year is in Belgrade! I'd better start filling in those CfPs...</p>

<p>Thanks to everyone who supported me this year in my conference speaking, especially <a href="https://twitter.com/_md">Marcello</a>, <a href="https://twitter.com/everzet">Konstantin</a> and the rest of the community of amazing speakers at <a href="http://inviqa.com">Inviqa</a>.</p>

<p>Thanks also to my wife <a href="https://twitter.com/RosamondMc">Rosamond</a> for not minding the disruption to our own lives <em>too</em> much!</p>
]]></content>
        </entry>
            <entry>
            <title type="html"><![CDATA[Speaking at PHPUK 2015]]></title>
            <link href="/speaking-at-phpuk-2015"/>
            <updated>2015-07-10T00:00:00+00:00</updated>
            <id>/speaking-at-phpuk-2015</id>
            <content type="html"><![CDATA[<p>I was lucky enough to be accepted to speak at PHPUK in February of this year (I am of course writing about it pretty late
on account of my recent return to blogging).</p>

<p>It was my first full-length conference talk, which was pretty cool because PHPUK was the first conference I ever went to,
I think back in 2009. I remember coming back from my first one reeling from the amount of quality talks and community spirit
I'd been exposed to. I've been going most years since, it's generally a high quality conference so I was thrilled to have been picked, especially
to talk in the main room.</p>

<h2>The Talk</h2>

<p>I was particularly impressed with the videos this year. Whoever's doing the AV is doing a cracking job, and they
were all uploaded to YouTube.</p>

<p><iframe width="560" height="315" src="https://www.youtube.com/embed/DlgadZLOK-M" frameborder="0" allowfullscreen></iframe></p>

<h2>Health Problems</h2>

<p>I was speaking on the second day, so I spent day 1 watching talks and generally hanging around the <a href="http://inviqa.com">Inviqa</a> stand
chatting to people. As the day went on, I started to worry because my voice was getting croakier and croakier. By the end of the day I
was finding it hard to get words out so decided to skip the social at a nearby bowling alley (a shame because it looked amazing).</p>

<p>On day 2 I woke up and found I genuinely couldn't speak! I drank a few cups of soothing tea and frantically googled for solutions.
Luckily <a href="https://twitter.com/tonypiper">Tony</a> (who is a chorist so knows such things) was very reassuring on Slack and recommended a particular throat mixture to me
that, as he said, "Tastes like camel piss".</p>

<p>I dutifully gargled and drank the stuff all day and by the afternoon my voice had mostly come back. In the end the talk came out ok,
I think if you know me you can tell I'm struggling but a stranger might just think I had a gruff voice. I didn't stay long at the social
because I could feel it going again.</p>

<p>Over the weekend I consulted a doctor and was told to try not to speak at all. Eventually my voice came back after 3-4 days but it was
a scary experience, especially for someone who's building a speaking career. In the end it was just a random infection so
I'm not too worried.</p>

<h2>The future</h2>

<p><a href="https://joind.in/talk/view/13393">Feedback on the talk</a> has been pretty good and overall I have to say it was a great experience. I'll definitely be submitting
next year!</p>
]]></content>
        </entry>
            <entry>
            <title type="html"><![CDATA[Testing Constructors with PhpSpec 2.3]]></title>
            <link href="/testing-constructors-with-phpspec-2"/>
            <updated>2015-07-06T00:00:00+00:00</updated>
            <id>/testing-constructors-with-phpspec-2</id>
            <content type="html"><![CDATA[<p>At the weekend I tagged the first (hopefully only) beta release of PhpSpec 2.3.0. You can see the <a href="https://github.com/phpspec/phpspec/releases/tag/2.3.0-beta">details of the release here</a></p>

<p>Several of the features relate to constructors, so I thought it was worth going through the differences to how you deal with
constructors when specifying classes.</p>

<h1>Describing construction in 2.2.x</h1>

<p>Since the 2.0 release you have always been able to describe simple constructors:</p>

<pre><code class="php">$this-&gt;beConstructedWith(100, 'param');
</code></pre>

<p>This works fine when describing <code>__construct</code> but a common pattern nowadays is to use Named Constructors. We did not have
a sensible way to describe them until <a href="http://github.com/thecrimpmaster">Jason</a> added a neat syntax for doing this version 2.2.0:</p>

<pre><code class="php">$this-&gt;beConstructedThrough('named', ['Ciaran']);
</code></pre>

<p>This describes a class that has something like the following implementation of a static class:</p>

<pre><code class="php">public static function named($name)
{
    $user = new User();
    $user-&gt;name = $name;

    return $user;
}
</code></pre>

<p>Which allows the more readable:</p>

<pre><code class="php">$user = User::named('Ciaran');
</code></pre>

<p>This opened up a lot of possibilities but there were a few issues:</p>

<ol>
<li>The public constructor still existed (Jason's original PR actually handled this but for some reason I got him to remove it).</li>
<li>From observing people using the tool, it became apparent that using an array of parameters caused confusion.</li>
<li>There was no sensible way of testing named constructors throwing Exceptions (e.g. when guarding invariants)</li>
</ol>

<h1>Describing constructors in 2.3.0</h1>

<p>You can now describe named constructors using a shortcut syntax:</p>

<pre><code class="php">$this-&gt;beConstructedNamed('Ciaran');
</code></pre>

<p>This is the equivalent of the case above, without the need to pass the arguments as an array. In short anything matching
<code>beConstructed*()</code> or <code>beConstructedThrough*()</code> are converted to an equivalent <code>beConstructedThrough()</code> call.</p>

<p>The aim of this is to make the specs more readable - the cost is that there is now more than one way of specifying these things.
Time will tell whether this works or not.</p>

<p>Another new addition is that when generating a named constructor, you will be asked:</p>

<pre><code>Do you want me to make the constructor of CLASS private for you? [Y/n]
</code></pre>

<p>When answering yes a private <code>__construct</code> is generated, meaning the named constructor must be used to create instances of the object.</p>

<h1>Describing constructor failure in 2.2.x</h1>

<p>Until now, it's only been possible to test a constructor that throws an exception by explicitly invoking it:</p>

<pre><code class="php">$this-&gt;shouldThrow('InvalidArgumentException')-&gt;during('__construct', ['']);
</code></pre>

<p>This suffers the same problems that <code>beConstructedThrough</code> had - mostly people forgetting to put single arguments inside
an array.</p>

<p>It was vaguely dissatisfying that you tested the constructor by invoking it, and potentially had to repeat the arguments
again, even if you'd called <code>beConstructedWith</code>. Worse, there was no sensible way to specify a static constructor
throwing an argument.</p>

<h1>Describing constructor failure in 2.3.0</h1>

<p>Thanks to <a href="https://github.com/acasademont">Albert</a> we have a new syntax specifically for describing this sort of exception
that does not care what the construction method used was:</p>

<pre><code class="php">$this-&gt;beConstructedWith(-100);
$this-&gt;shouldThrow('InvalidArgumentException')-&gt;duringInstantiation();
</code></pre>

<p>or</p>

<pre><code class="php">$this-&gt;beConstructedNamed('InvalidName');
$this-&gt;shouldThrow('InvalidArgumentException')-&gt;duringInstantiation();
</code></pre>

<p>For me this is much clearer, and really helps with the clarity of the specs.</p>

<h1>One last thing...</h1>

<p>Something that's bugged me for years is that when PhpSpec generates a constructor method it does so at the end of the
class. Thanks to <a href="https://github.com/shanethehat">Shane</a> it's now placed up front in the class!</p>

<p>This is the sort of small change that takes a big effort to implement, so thanks Shane and all the other contributors who've
made this release great.</p>
]]></content>
        </entry>
            <entry>
            <title type="html"><![CDATA[Faster failing Unit Tests]]></title>
            <link href="/faster-failing-unit-tests"/>
            <updated>2012-02-08T00:00:00+00:00</updated>
            <id>/faster-failing-unit-tests</id>
            <content type="html"><![CDATA[<p>One of the things about unit tests is that if they're going to fail, it's best if they fail quickly.

<p>(This is also a key element of Scrum and other Agile approaches - if you're going to fail, do it as early as possible).

<p>I was listening to <a href="http://www.se-radio.net/2010/09/episode-167-the-history-of-junit-and-the-future-of-testing-with-kent-beck/">this old episode of Software Engineering Radio</a> and in it Kent Beck made the following observations:

<ol>
<li>Ideally you want to run the tests most likely to fail first, so that you get faster feedback
<li>Statistically the most likely tests to fail are the ones that failed recently (i.e. if a test hasn't failed for a while it's less likely to fail next time).
</ol>

<p>This really clicked with me, especially for things like CI, so I knocked up the following hacky script to run my phpunit tests through:

<p><code><pre>
&lt;?php

$run_full = true;

if (file_exists('last_run_report.xml')) {
    
    $failures = array();
    $xml = simplexml_load_file('last_run_report.xml');
    
    if ($res = $xml-&gt;xpath('//error/../@file')) {
        foreach ($res as $file) {
            $failures[] = (string)$file;
        }
    }

    if ($failures) {
        echo 'PREVIOUSLY FAILING TESTS', PHP_EOL;
        echo '------------------------', PHP_EOL;
        passthru('phpunit '.join(' ', $failures), $exit);
        
        if ($exit &gt; 0) { 
            $run_full = false; 
        }
        else {
            echo PHP_EOL;
            echo 'FULL TEST SUITE', PHP_EOL;
            echo '---------------', PHP_EOL;
        }
    }
}

if($run_full){
    passthru('phpunit --log-junit last_run_report.xml');
}
</pre></code></p>

<p>When I use this to run my test suite instead of straight phpunit, it results in a local file called last_run_report.xml being generated. Next time I run the report, if there were any errors, the report is parsed and the failing tests are executed first.

<p>This is <em>really primitive</em> but is already saving me a little time. The next step would be to get a DB involved and maybe log the last few executions of the current suite, to get some stats on how unstable tests have been over the last few executions and prioritise them that way.

<p>I'm sure there's a bunch of other analysis you could do to work out statistically which tests are likely to fail - you could even do some sort of static code analysis and work out which tests have ben potentially impacted since the last test run.

<p>I'll be running this little script locally for now, but with an eye to including it in our CI environment once I've a bit more confidence that it's a valid approach.]]></content>
        </entry>
            <entry>
            <title type="html"><![CDATA[Use labelled groups in Regular Expressions for clearer code]]></title>
            <link href="/use-labelled-groups-in-regular-expressions-for-clearer-code"/>
            <updated>2011-05-12T00:00:00+00:00</updated>
            <id>/use-labelled-groups-in-regular-expressions-for-clearer-code</id>
            <content type="html"><![CDATA[<p>I keep seeing this sort of pattern in PHP code, when people match on Regular Expressions:

<p><code><pre>
$orderNumber = 'CLK-TEST001-030';
$pattern = '/([a-z]+)-([a-z]+([0-9]+))?-([0-9]+)/i';

if (preg_match($pattern , $orderNumber, $matches)) {
    echo "Prefix was ".$matches[1]." and duration was ".$matches[4];
} 
</pre></code></p>

<p>The problem here is that the numbers 4 and 1 are kind of cryptic. Furthermore if the expression changes in future I'll probably need to go through my code and redo the numbering.

<p>A better alternative is to name the groups inside the expression:

<p><code><pre>
$orderNumber = 'CLK-TEST001-030';
$pattern = '/(?&lt;prefix&gt;[a-z]+)-([a-z]+([0-9]+))?-(?&lt;duration&gt;[0-9]+)/i';

if (preg_match($pattern , $orderNumber, $matches)) {
    echo "Prefix was ".$matches['prefix'].
        " and duration was ".$matches['duration'];
} 
</pre></code></p>

<p>This way if the expression gets changed, I can still use the same named fields in my matches in the subsequent code.

<p>I don't know why this isn't done more often, except perhaps poor documentation means that people just aren't aware of it?


]]></content>
        </entry>
            <entry>
            <title type="html"><![CDATA[Using partial mocks in PHPUnit to test tricky code]]></title>
            <link href="/using-partial-mocks-in-phpunit-to-test-tricky-code "/>
            <updated>2011-04-30T00:00:00+00:00</updated>
            <id>/using-partial-mocks-in-phpunit-to-test-tricky-code </id>
            <content type="html"><![CDATA[<p>At work we've been going through the fairly painful process of adding unit tests to existing code. I'd like to share one technique I've found useful, a way of testing methods that at first glance look like they have too many dependencies to easily get under test.

<p>I'll be giving these examples in PHPUnit but any xUnit framework should be able to do something similar.

<p>Consider a method like the following, which is the sort of thing you might have trouble seeing how to test:

<p><code><pre>
class MyClass
{
    public function getDataAndPublishRemotely()
    {
        $data = DataStore::getUnpublishedData();
        
        $service = new SoapClient($SOME_WSDL);
        $service-&gt;publish(preg_replace('/[^0-9a0z]+/', '', $data));
    }
} 
</pre></code></p>

<p>So this is doing some sort of DB call, then calling a SOAP service and publishing a cleaned-up version of the result. What makes this hard to test is the fact it's got two solid dependencies - a static call to some sort of DataStore layer and a direct instance of a SoapClient class.

<p>Eventually the way to fix this sort of thing is to inject both of those dependencies separately, but that's too big a refactoring to tackle straight away. When you're modifying a class to get it under test you want to do small, easy-to-understand changes and get it under test ASAP.

<p>One approach to getting it tested is to split the functionality that you think you can test into a separate method, like so:

<p><code><pre>
class MyClass
{
    public function getDataAndPublishRemotely()
    {
        $data = DataStore::getUnpublishedData();
        $cleanData = $this-&gt;processData($data);
        
        $service = new SoapClient($SOME_WSDL);
        $service-&gt;publish($cleanData);
    }
    
    public function processData($data)
    {
        return preg_replace('/[^0-9a0z]+/', '', $data);
    }
}
</pre></code></p>

<p>Testing that functionality becomes pretty simple:

<p><code><pre>
class MyClassTest extends PHPUnit_Framework_Testcase
{
    public function testProcessData()
    {
        $data = ' hel123lo wo00rld    ';
        $class = new MyClass();
        
        $result = $class-&gt;processData();
        
        $this-&gt;assertSame('hello world', $data);
    }
}
</pre></code></p>

<p>However there are a few things wrong with this approach, in my opinion. The first is that the new method has had to be public to be tested, so we've fundamentally changed the API of the class just for testing. The second is that we're not actually running the method we started off trying to test, which is unsatisfying. Thirdly, we're not aware whether the method is accessing the datastore or soap service at all, we're only testing the small bit of functionality we split off.

<p>A better refactoring of the original class is to instead of splitting out the bits easy to test, split out the bits that are hard to test like so:

<p><code><pre>
class MyClass
{
    public function getDataAndPublishRemotely()
    {
        $data = $this-&gt;_getUnpublishedDataFromDatastore();
        $cleanData = preg_replace('/[^0-9a0z]+/', '', $data);
        $this-&gt;_publishDataRemotely($cleanData);
    }
    
    protected function _getUnpublishedDataFromDatastore()
    {
        return DataStore::getUnpublishedData();
    }
    
    protected function _publishDataRemotely($data)
    {
        $service = new SoapClient($SOME_WSDL);
        $service-&gt;publish($data);
    }
}
</pre></code></p>

<p>It's important to note, I suppose, that this is longer than the original class! However, the API of the class hasn't changed, and all of the dependencies have been removed from the method we're interested in. The small additional methods that have been generated can be refactored out later, the point is to do this simple change and get the system under test as soon as possible, then we can do our subsequent refactoring with a safety net in place.

<p>If you have an IDE that can do refactorings like this (Extract Method) for you, then use the features! It's easy to make a mistake in even a little refactoring like this one and you should be very nervous about untested code.

<p>To test the class we need to replace the two protected functions. One way of doing that would be to write a concrete MyTestableClass that extends MyClass and replace those methods and test that instead, but we can achieve effectively the same thing in PHPUnit using Partial Mocks. A partial mock is one that behaves exactly like the original class except when certain specific methods are called.

<p>The test for the class could therefore look something like the following, note that all of the testing is done via expectations on the mock rather than via assertions:

<p><code><pre>
class MyClassTest extends PHPUnit_Framework_Testcase
{

    public function testGetDataAndPublishRemotely()
    {
        $class = $this-&gt;getMock('MyClass', 
            array('_getUnpublishedDataFromDatastore', '_publishDataRemotely'));
        
        $class-&gt;expects($this-&gt;once())
            -&gt;method('_getUnpublishedDataFromDatastore')
            -&gt;will($this-&gt;returnValue(' hel123lo wo00rld    '));
            
        $class-&gt;Expects($this-&gt;once())
            -&gt;method('_publishDataRemotely')
            -&gt;with($this-&gt;equalTo('hello world'));
        
        $class-&gt;getDataAndPublishRemotely();
    }

}
</pre></code></p>

<p>A purist might say that's testing too much in one test and should be decomposed into different tests, but it's concise enough for me. Note we're testing more than the previous example, which only tested the string cleanup. In this test we are testing:

<ul>
<li>The string processing</li>
<li>The fact it requests the data from the DB</li>
<li>The fact it subsequently tries to publish the data</li>
</ul>

<p>This isn't the end of the story, because testing a mock seems a bit wrong, and it would be nice to clear up those dependencies properly. The point is that we've done the simplest thing necessary to get the method into a test harness, and subsequent refactorings can all be done with the test suite in place giving you the developer additional confidence to make changes.]]></content>
        </entry>
            <entry>
            <title type="html"><![CDATA[Zend Framework bindings for Frontal]]></title>
            <link href="/zend-framework-bindings-for-frontal"/>
            <updated>2010-04-06T00:00:00+00:00</updated>
            <id>/zend-framework-bindings-for-frontal</id>
            <content type="html"><![CDATA[<p>Having thought further about <a href="/source/blog/2010/03/frontal-a-new-approach-to-triggering-javascript-behaviour">Frontal, Carl's JS library</a>, I wrote a quick View Helper to make it easier to use it in Zend Framework projects.</p>

<p>It's <a href="http://dl.dropbox.com/u/1845336/Frontal-ZF.tar.gz">available to download</a> on Dropbox, it's available under the MIT licence.  I'll bung it up on somewhere like GitHub once I work out how Git works.</p>

<h4>Basic usage</h4>

<p>Before you do anything you'll need to register the helpers in your <tt>application.ini</tt>:</p>

<code><pre>
resources.view.helperPath.Frn_View_Helper = /path/to/Frn/View/Helper
</pre></code>

<p>to get it to output anything you'll need to echo the frontal helper at the bottom of the page:</p>

<code><pre>
...
&lt;?= $this->frontal() ?&gt;
&lt;/body&gt;
</pre></code>

<p>By default this will echo nothing! Don't panic, it'll start doing things once you've loaded some stuff into it.  The main use-case here is that you're echoing the helper out in some sort of template (Zend_Layout particularly) but pushing configuration into it from your individual views.</p>

<p>Firstly, you can override the path Frontal will use, for instance if there's a page appears under lots of different URLs but you just want one rule that matches it against '/foo':</p>

<code><pre>
&lt;? $this->frontal->location('/foo'); ?&gt;

will output:

&lt;script&gt;
$frn.location('/foo');
&lt;/script&gt;
</pre></code>

<p>Secondly, you can provide some data that frontal might find useful (rather than dump it in global scope).  The data is auto-converted to JSON so it's a fairly nice way of feeding data from PHP to JS:</p>

<code><pre>
&lt;? $this->frontal->data(array('foo', 'bar')); ?&gt;

will output:

&lt;script&gt;
$frn.data(["foo","bar"]);
&lt;/script&gt;
</pre></code>

<p>That's pretty much it for now, but it works pretty well and I'm going to be building it into a work project.</p>
]]></content>
        </entry>
            <entry>
            <title type="html"><![CDATA[Clarifying Javascript-PHP communication using JSON-RPC]]></title>
            <link href="/clarifying-javascript-php-communication-using-json-rpc"/>
            <updated>2010-03-15T00:00:00+00:00</updated>
            <id>/clarifying-javascript-php-communication-using-json-rpc</id>
            <content type="html"><![CDATA[<p>I think of myself first and foremost as a PHP developer but serious sites are getting more and more JS-heavy as time goes on so it gets harder (and less pragmatic) to try and avoid dealing with JS<->PHP communication of some sort.</p>

<p>I'm a big advocate of RESTful design so tend to end up attempting to write scripts that do lots of GETs and POSTs (as appropriate) and parsing out whatever custom response format I've decided JSON requests will return.  It feels good - like I'm sticking to my principles and 'doing it right' but it's a long painful slog that can feel like self-flagellation at times.</p>

<p>It's also slow and hard to prototype - it's hard to argue in favour of some abstract design idea when it's making you take forever to generate simple tasks .  Sometimes when I feel lazy what I really want is a way of calling my PHP objects directly from the JS and not worrying about what's happening in the underlying HTTP, and that's what <a href="http://json-rpc.org">JSON-RPC</a> provides.</p>

<p>In this blog I'll be showing some simple examples of JSON-RPC in action but first let's look at the pros and cons.</p>

<h4>Why JSON-RPC is awesome:</h4>

<ul>
<li>It includes basic error handling as part of the protocol</li>
<li>It hides away all the client-server communications from me the developer</li>
<li>It looks a bit like SOAP so is fairly familiar</li>
<li>I don't have to spend time writing RESTful response formats and pondering URLs to get working code</li>
</ul>

<h4>Why JSON-RPC sucks:</h4>

<ul>
<li>It's not <a href="http://en.wikipedia.org/wiki/Rest">REST</a>ful - requests from the client come in as POSTs to on URL without a clear semantic 'resource' behind it</li>
<li>There may be specifics to the HTTP that aren't covered by the abstraction</li>
</ul>

<p>I suspect a lot of developers reading the lists above will be thinking "hell yeah, sounds good, how can I have it?"</p>

<h4>The protocol</h4>

<p>I won't go into all the ins and outs of the protocol but it's worth taking a quick look.  The basic paradigm is that the server has a bunch of methods that can be called by the client, that take different parameters.</p>

<p>An example request is a POST to the server that looks like this:</p>

<p><tt>{ "method": "greet", "params": ["Ciaran"], "id": 1234 }</tt></p>

<p>This is the PHP equivalent of $server->greet("Ciaran").  The ID parameter is used to match up requests and responses.  The response would look like this:</p>

<p><tt>{ "result": "Hello Ciaran", "error": null, "id": 1234 }</tt></p>

<p>So the result is a string literal with no error conditions - there's not much more to it than that to be honest, aside from error handling.</p>

<p>It would be fairly simple to implement either side of the protocol yourself on a project, but the real strength is of course that once something is a standard, the rest of the world goes to work on it and starts writing up libraries that lazy programmers like us can use! Let's take a look at two libraries, a Zend Framework one on the PHP end and a jQuery one on the Javascript end.</p>

<h4>JSON-RPC in PHP: Zend_Json_Server</h4>

<p><a href="http://framework.zend.com/manual/en/zend.json.server.html">Zend_Json_Server</a> is pretty simple to use, you will need a class that exposes and handles the methods you're going to be using that's properly docblock commented (this is used by the component to see the parameter and return types):</p>

<code><pre>class My_Service_Handler
{
    /**
    * @param string $name
    * @return string
    */
    public function greet($name)
    {
        return "Hello $name";
    }
}
</code></pre>

<p>You can then proxy JSON-RPC requests along into this object using the Zend Framework component, Zend_Json_Server:</p>

<code><pre>
$server = new Zend_Json_Server();
$server->setClass('My_Service_Handler');
$server->handle();
</pre></code>

<p>Now any requests like our examples above will get an appropriate response.  Again fairly straightforward stuff I think, and should be familiar to anyone who's used a SOAP server in PHP.  All of the complexity of decoding the response and encoding the request is handled by the component.</p>

<h4>JSON-RPC in JQuery: zendjsonrpc</h4>

<p>There are a huge number of jQuery plugins to do JSON-RPC, but <a href="http://plugins.jquery.com/project/zendjsonrpc">this one is specifically written to work with the Zend_Json_Server</a> so I figured it's as good an example as any.  If you look at the source code of the plugin it's fairly straightforward and I'm sure it'd be easy to write your own if you preferred.  The basic usage is:</p>

<code><pre>
var client = jQuery.Zend.jsonrpc({url: '/path/to/service/handler.php'});
var message = client.greet("Ciaran");
alert(message);
</pre></code>

<p>As you can see, once the client object is constructed with the service URL you as a developer have a local JS object that exposes the exact same methods the My_Service_Handler has.</p>

<h4>Overall</h4>

<p>What I really find attractive about the JSON-RPC protocol is that, well, someone else has implemented it for me in the two components above.  That means that I can stop worrying about AJAX and start pretending that my PHP object is somehow present locally in my JS and that I can just call its methods at will.</p>

<p>That's a really powerful abstraction. No doubt like most abstractions there are places where it leaks around the edges but the simplicity of the idea and the clarity it brings to JS<->PHP communication make it an approach I'll be certainly investigating for my next JS-heavy project.</p>
]]></content>
        </entry>
            <entry>
            <title type="html"><![CDATA[Why you should close PHP sessions as soon as you can]]></title>
            <link href="/why-you-should-close-php-sessions-as-soon-as-you-can"/>
            <updated>2009-12-23T00:00:00+00:00</updated>
            <id>/why-you-should-close-php-sessions-as-soon-as-you-can</id>
            <content type="html"><![CDATA[<p>When serving files with PHP, you may notice a curious effect where only one request gets served at a time per user.</p>

<p>You can see it if you're the kind of retro throwback who uses framesets served via PHP - the panels will load in one at a time.  You'll see the same thing if you generate a load of images via PHP - they'll pop up sequentially - and if you serve large video files via PHP like we do at work you may see a curious effect of the downloads queueing up.  Those of you with AJAX applications may be victim to this without realising, but if you're serving JSON/XML responses from PHP scripts you'll find that your parallel AJAX requests will only get served one at a time.</p>

<p>I've seen this effect a few times and always ended up working around it.  The odd thing is this isn't a setting in Apache or a global slowdown of your server. PHP just refuses to serve more than one request per user at a time.  Luckily <a href="http://twitter.com/kevindmorgan" rel="friend">Kevin</a> managed to spot the reason, and it was a new one on me even after 9+ years of using PHP (it's possible everyone else knows about it, mind you).</p>

<p>The answer is pretty simple: <strong>PHP can only handle one response at a time if you have an open session</strong>.</p>

<p>This makes perfect sense when you think about it - when you <tt>session_start()</tt> PHP has to read the data out of the session, then at the end of your script it has to write the data back - if this was happening in parallel then you'd have classic race conditions.  To handle this PHP locks the session on <tt>session_start()</tt> and other pending requests will block until the lock is released.</p>

<p>This leads to some guidelines:</p>

<ol>
<li>Don't start sessions with <tt>session_start()</tt> until you need them (but remember you have to start them before your script output begins).   This would also imply not using session.autostart if you can avoid it.</li>
<li>When serving files via PHP, consider serving them from a different domain so the sessions don't overlap.</li>
<li>End your sessions as soon as you can.  By calling <tt>session_write_close()</tt> you can release your session lock, so as soon as you know your script won't need to write any more to the session, call it.</li>
</ol>

<p>Hopefully this will help out somebody in a similar situation in future!</p>
]]></content>
        </entry>
            <entry>
            <title type="html"><![CDATA[Doctrine article in php|architect]]></title>
            <link href="/doctrine-article-in-php-architect"/>
            <updated>2009-08-27T00:00:00+00:00</updated>
            <id>/doctrine-article-in-php-architect</id>
            <content type="html"><![CDATA[<p>Ah, fame at last!</p>
<div>
 <div class="figure narrow">
    <a href="http://phparch.com/c/phpa/magazine/index"><img src="http://static.phparch.com/common/issues/small/0104.jpg" width="200" height="258" alt="Cover of php|architect"/></a>
    <p class="caption">The latest issue</p>
</div>

<p>It looks like <a href="http://phparch.com/c/phpa/magazine/index">the new issue of php|architect</a> is out, and contains my article about <a href="http://www.doctrine-project.org/documentation">Doctrine</a>, the PHP-based Object Relational Mapper.</p>

<p>It feels like ages since I wrote it (I'm no longer a 'freelance PHP developer' for a start) so re-reading it was actually a slightly weird experience.</p>
</div>
<p>It's my first published work, and I'm fairly happy with it.  Hopefully I'll get another chance to write for php|architect, I just need to think of another subject that I have something to say about.</p>

<p>The bad news for most of you cheapskates is that php|architect is a subscription-only publication so you can't read my article for free!  However, I would genuinely recommend the magazine, especially as it's only effectively $2.50/issue.  Obviously I wouldn't recommend it for people who aren't interested in PHP, however!</p>]]></content>
        </entry>
    </feed>